<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Interview Panel Pro</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#070b14;--surface:#0d1425;--surface2:#131d30;--border:#1a2540;
  --alex:#2563eb;--alex-dim:#1e3a8a;--alex-glow:#3b82f650;
  --sam:#7c3aed;--sam-dim:#4c1d95;--sam-glow:#8b5cf650;
  --user:#0f4c3a;--text:#e2e8f0;--muted:#64748b;
  --success:#10b981;--danger:#ef4444;--warn:#f59e0b;
  --radius:14px;
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100dvh;overflow:hidden;display:flex;flex-direction:column}

/* â”€â”€ Modal Overlay â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:#00000099;display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(6px)}
.modal-overlay.hidden{display:none}
.modal-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;width:90%;max-width:560px;max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;gap:20px}
.modal-card h2{font-size:1.5rem;font-weight:700;color:#93c5fd;text-align:center}
.modal-card p{color:var(--muted);text-align:center;font-size:.9rem}

/* Startup Modal */
.modal-label{font-size:.8rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.modal-input{width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;font-size:.95rem;color:var(--text);outline:none;transition:border-color .2s}
.modal-input:focus{border-color:var(--alex)}
.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.mode-card{background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:14px;cursor:pointer;transition:all .2s;text-align:center}
.mode-card:hover{border-color:var(--alex)}
.mode-card.selected{border-color:var(--alex);background:#1e3a8a20}
.mode-card .mode-emoji{font-size:1.8rem;margin-bottom:6px}
.mode-card .mode-title{font-size:.82rem;font-weight:600}
.permissions-note{background:#1c2a1a;border:1px solid #2d4a2d;border-radius:10px;padding:12px;font-size:.8rem;color:#86efac;text-align:center}
.btn-primary{background:var(--alex);color:white;border:none;border-radius:12px;padding:14px;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;width:100%}
.btn-primary:hover{filter:brightness(1.15)}
.btn-primary:disabled{opacity:.4;cursor:not-allowed}

/* Feedback Modal */
.modal-card.feedback{max-width:680px}
.feedback-header{display:flex;justify-content:space-between;align-items:center}
.verdict-badge{padding:6px 18px;border-radius:20px;font-size:.85rem;font-weight:700}
.verdict-badge.strong_hire{background:#14532d;color:#86efac}
.verdict-badge.hire{background:#1e3a8a;color:#93c5fd}
.verdict-badge.hold{background:#78350f;color:#fcd34d}
.verdict-badge.no_hire{background:#7f1d1d;color:#fca5a5}
.score-wrap{display:flex;align-items:center;gap:20px}
.score-circle{width:90px;height:90px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;border:4px solid var(--alex)}
.score-circle .big{font-size:2rem;line-height:1}
.score-circle .small{font-size:.75rem;color:var(--muted)}
.feedback-summary{font-size:.9rem;line-height:1.6;color:#cbd5e1}
.categories-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.cat-card{background:var(--surface2);border-radius:10px;padding:12px}
.cat-name{font-size:.72rem;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
.cat-bar-wrap{background:#1a2540;border-radius:4px;height:6px;margin-bottom:6px}
.cat-bar{height:6px;border-radius:4px;background:var(--alex);transition:width .5s ease}
.cat-feedback{font-size:.78rem;color:#94a3b8;line-height:1.4}
.feedback-lists{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.feedback-lists h4{font-size:.82rem;font-weight:700;margin-bottom:8px}
.feedback-lists ul{list-style:none;display:flex;flex-direction:column;gap:6px}
.feedback-lists li{font-size:.82rem;color:#cbd5e1;padding:6px 10px;background:var(--surface2);border-radius:8px}
.integrity-box{background:#1c1a0a;border:1px solid #78350f40;border-radius:10px;padding:12px;font-size:.82rem;color:#fcd34d}
.integrity-box.ok{background:#0a1c0f;border-color:#14532d40;color:#86efac}
.recommendation-box{background:var(--surface2);border-radius:10px;padding:14px;font-size:.88rem;line-height:1.6;color:#cbd5e1}
.feedback-actions{display:flex;gap:10px}
.btn-secondary{flex:1;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .2s}
.btn-secondary:hover{border-color:var(--alex)}
.feedback-actions .btn-primary{flex:1}

/* â”€â”€ App Layout â”€â”€ */
#app{display:flex;flex-direction:column;height:100dvh;padding:10px;gap:10px}
#app.hidden{display:none}

.app-header{display:flex;align-items:center;justify-content:space-between;padding:0 4px;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:10px}
.mode-pill{padding:4px 12px;border-radius:20px;background:var(--surface2);border:1px solid var(--border);font-size:.78rem;font-weight:600;color:#93c5fd}
.candidate-name{font-size:.82rem;color:var(--muted)}
.app-header h1{font-size:1.1rem;font-weight:700;color:#93c5fd}
.header-right{display:flex;align-items:center;gap:10px}
#timer{font-size:.85rem;color:var(--muted);font-variant-numeric:tabular-nums}
.btn-end{background:#7f1d1d;color:#fca5a5;border:none;border-radius:10px;padding:7px 14px;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s}
.btn-end:hover{background:#991b1b}

.main-layout{flex:1;display:grid;grid-template-columns:260px 1fr;gap:10px;min-height:0}

/* Sidebar */
.sidebar{display:flex;flex-direction:column;gap:10px;min-height:0}
.webcam-wrap{position:relative;border-radius:var(--radius);overflow:hidden;background:#000;aspect-ratio:4/3;flex-shrink:0}
#webcam{width:100%;height:100%;object-fit:cover;display:block}
.face-pill{position:absolute;bottom:8px;left:8px;right:8px;background:#00000099;backdrop-filter:blur(6px);border-radius:8px;padding:5px 10px;font-size:.72rem;font-weight:600;display:flex;align-items:center;gap:5px}
.face-pill.ok{color:#86efac}
.face-pill.warn{color:#fcd34d}
.face-pill.danger{color:#fca5a5}
.face-dot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0}

.proctor-panel{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;min-height:0;overflow:hidden}
.proctor-header{padding:10px 14px;font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.flag-count{background:var(--danger);color:white;font-size:.7rem;font-weight:700;padding:2px 7px;border-radius:10px}
#proctor-log{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px}
.proctor-item{background:var(--surface2);border-left:3px solid var(--warn);border-radius:6px;padding:7px 10px;font-size:.72rem;line-height:1.4}
.proctor-item.danger{border-color:var(--danger)}
.proctor-time{color:var(--muted);font-size:.68rem;margin-bottom:2px}
.proctor-desc{color:#cbd5e1}
.proctor-empty{color:var(--muted);font-size:.78rem;text-align:center;padding:20px;font-style:italic}

/* Interview Panel */
.interview-panel{display:flex;flex-direction:column;gap:8px;min-height:0}
.panelists{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex-shrink:0}
.panelist{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:10px 14px;display:flex;align-items:center;gap:10px;transition:border-color .3s,box-shadow .3s;position:relative;overflow:hidden}
.panelist::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity .3s;border-radius:inherit;pointer-events:none}
.panelist.alex::before{background:radial-gradient(ellipse at left,#2563eb15,transparent 70%)}
.panelist.sam::before{background:radial-gradient(ellipse at left,#7c3aed15,transparent 70%)}
.panelist.speaking{border-color:var(--active);box-shadow:0 0 20px var(--active-glow)}
.panelist.speaking::before{opacity:1}
.panelist.alex.speaking{--active:var(--alex);--active-glow:var(--alex-glow)}
.panelist.sam.speaking{--active:var(--sam);--active-glow:var(--sam-glow)}
.avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;position:relative}
.avatar.alex{background:var(--alex-dim)}
.avatar.sam{background:var(--sam-dim)}
.ring{position:absolute;inset:-4px;border-radius:50%;border:2px solid transparent;transition:border-color .2s}
.speaking .ring.alex{border-color:var(--alex);animation:spin-ring 1.5s linear infinite}
.speaking .ring.sam{border-color:var(--sam);animation:spin-ring 1.5s linear infinite}
@keyframes spin-ring{0%{transform:rotate(0)scale(1);opacity:1}50%{transform:rotate(180deg)scale(1.05);opacity:.7}100%{transform:rotate(360deg)scale(1);opacity:1}}
.info{flex:1;min-width:0}
.pname{font-weight:700;font-size:.88rem}
.pname.alex{color:#93c5fd}
.pname.sam{color:#c4b5fd}
.prole{font-size:.7rem;color:var(--muted);margin-top:2px}
.wave{display:flex;align-items:center;gap:3px;height:18px;opacity:0;transition:opacity .2s}
.speaking .wave{opacity:1}
.wave-bar{width:3px;border-radius:2px;animation:wave 0.8s ease-in-out infinite}
.panelist.alex .wave-bar{background:var(--alex)}
.panelist.sam .wave-bar{background:var(--sam)}
.wave-bar:nth-child(1){height:5px;animation-delay:0s}
.wave-bar:nth-child(2){height:13px;animation-delay:.15s}
.wave-bar:nth-child(3){height:9px;animation-delay:.3s}
.wave-bar:nth-child(4){height:15px;animation-delay:.1s}
.wave-bar:nth-child(5){height:7px;animation-delay:.25s}
@keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(.3)}}

#chat-box{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth;min-height:0}
.bubble{max-width:80%;padding:9px 13px;border-radius:13px;font-size:.88rem;line-height:1.6;animation:pop .25s ease}
@keyframes pop{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.bubble .bname{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;opacity:.75}
.bubble.alex{background:#1e3a8a25;border:1px solid #2563eb35;align-self:flex-start;border-bottom-left-radius:3px}
.bubble.sam{background:#4c1d9525;border:1px solid #7c3aed35;align-self:flex-start;border-bottom-left-radius:3px}
.bubble.user{background:var(--user);border:1px solid #10b98130;align-self:flex-end;border-bottom-right-radius:3px}
.bubble.sys{background:var(--surface2);border:1px solid var(--border);align-self:center;font-size:.78rem;color:var(--muted);font-style:italic;max-width:95%;text-align:center}
.bubble.alex .bname{color:#93c5fd}
.bubble.sam .bname{color:#c4b5fd}
.bubble.user .bname{color:#6ee7b7}
.cursor::after{content:'â–‹';animation:blink .7s step-end infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

#status{flex-shrink:0;text-align:center;font-size:.75rem;color:var(--muted);min-height:16px}
.controls{display:flex;gap:8px;align-items:flex-end;flex-shrink:0}
#input-box{flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:12px;padding:11px 14px;font-size:.9rem;color:var(--text);min-height:44px;max-height:100px;overflow-y:auto;outline:none;transition:border-color .2s;line-height:1.5}
#input-box:focus{border-color:var(--alex)}
#input-box:empty::before{content:'Type or speak your answer...';color:var(--muted);pointer-events:none}
.btn{padding:11px 15px;border:none;border-radius:12px;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;height:44px;display:flex;align-items:center;gap:5px}
.btn:hover:not(:disabled){filter:brightness(1.15);transform:translateY(-1px)}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none;filter:none}
#mic-btn{background:var(--alex);color:white}
#mic-btn.listening{background:var(--danger);animation:pulse-btn 1s ease infinite}
#mic-btn.interrupt{background:#f59e0b;color:#000}
#send-btn{background:var(--success);color:white}
@keyframes pulse-btn{0%,100%{box-shadow:0 0 0 0 #ef444460}50%{box-shadow:0 0 0 8px #ef444400}}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
</style>
</head>
<body>

<!-- â”€â”€ Startup Modal â”€â”€ -->
<div id="startup-modal" class="modal-overlay">
  <div class="modal-card">
    <h2>ğŸ™ï¸ AI Interview Panel</h2>
    <p>Configure your session to begin</p>

    <div>
      <div class="modal-label" style="margin-bottom:6px">Your Name</div>
      <input class="modal-input" type="text" id="candidate-name" placeholder="Enter your full name" />
    </div>

    <div>
      <div class="modal-label" style="margin-bottom:8px">Select Role</div>
      <div class="mode-grid" id="mode-grid"></div>
    </div>

    <div class="permissions-note">
      ğŸ“¹ Webcam &amp; microphone will be requested for proctoring
    </div>

    <button class="btn-primary" id="start-btn" disabled>Loading modes...</button>
  </div>
</div>

<!-- â”€â”€ Feedback Modal â”€â”€ -->
<div id="feedback-modal" class="modal-overlay hidden">
  <div class="modal-card feedback">
    <div class="feedback-header">
      <h2>ğŸ“‹ Interview Report</h2>
      <div id="verdict-badge" class="verdict-badge">--</div>
    </div>

    <div class="score-wrap">
      <div class="score-circle" id="score-circle">
        <div class="big" id="score-num">--</div>
        <div class="small">/ 10</div>
      </div>
      <div class="feedback-summary" id="fb-summary">Generating report...</div>
    </div>

    <div class="categories-grid" id="categories-grid"></div>

    <div class="feedback-lists">
      <div>
        <h4>âœ… Strengths</h4>
        <ul id="strengths-list"></ul>
      </div>
      <div>
        <h4>ğŸ“ˆ Improvements</h4>
        <ul id="improvements-list"></ul>
      </div>
    </div>

    <div id="integrity-box" class="integrity-box ok"></div>
    <div id="recommendation-box" class="recommendation-box"></div>

    <div class="feedback-actions">
      <button class="btn-secondary" id="dl-transcript-btn">ğŸ“¥ Download Transcript</button>
      <button class="btn-secondary" id="dl-audio-btn">ğŸµ Download Audio</button>
      <button class="btn-primary" id="close-feedback-btn">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Main App â”€â”€ -->
<div id="app" class="hidden">
  <header class="app-header">
    <div class="header-left">
      <span class="mode-pill" id="mode-pill">--</span>
      <span class="candidate-name" id="cand-display"></span>
    </div>
    <h1>ğŸ™ï¸ AI Interview Panel</h1>
    <div class="header-right">
      <span id="timer">00:00</span>
      <button class="btn-end" id="end-btn">End Interview</button>
    </div>
  </header>

  <div class="main-layout">
    <!-- Sidebar: Webcam + Proctoring -->
    <aside class="sidebar">
      <div class="webcam-wrap">
        <video id="webcam" autoplay muted playsinline></video>
        <canvas id="face-canvas" style="display:none"></canvas>
        <div class="face-pill ok" id="face-pill">
          <div class="face-dot"></div>
          <span id="face-text">Initializing camera...</span>
        </div>
      </div>

      <div class="proctor-panel">
        <div class="proctor-header">
          <span>ğŸ” Proctoring</span>
          <span id="flag-count" class="flag-count" style="display:none">0</span>
        </div>
        <div id="proctor-log">
          <div class="proctor-empty">No issues detected</div>
        </div>
      </div>
    </aside>

    <!-- Interview Panel -->
    <main class="interview-panel">
      <div class="panelists">
        <div class="panelist alex" id="card-alex">
          <div class="avatar alex">ğŸ§‘â€ğŸ’»<div class="ring alex"></div></div>
          <div class="info">
            <div class="pname alex">Alex</div>
            <div class="prole">Senior Engineer Â· Technical</div>
          </div>
          <div class="wave">
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div>
          </div>
        </div>
        <div class="panelist sam" id="card-sam">
          <div class="avatar sam">ğŸ§‘â€ğŸ’¼<div class="ring sam"></div></div>
          <div class="info">
            <div class="pname sam">Sam</div>
            <div class="prole">HR Specialist Â· Behavioral</div>
          </div>
          <div class="wave">
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div><div class="wave-bar"></div>
            <div class="wave-bar"></div>
          </div>
        </div>
      </div>

      <div id="chat-box"></div>
      <div id="status">Starting...</div>

      <div class="controls">
        <div id="input-box" contenteditable="true"></div>
        <button class="btn" id="mic-btn">ğŸ™ï¸</button>
        <button class="btn" id="send-btn">Send</button>
      </div>
    </main>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SESSION_ID   = "panel_" + Date.now();
let selectedMode   = "software_engineer";
let isBusy         = false;
let isListening    = false;
let recognition    = null;
let timerSec       = 0;
let timerInterval  = null;
let flagCount      = 0;

// Audio
const audioCtx     = new (window.AudioContext || window.webkitAudioContext)();
const audioQueue   = [];
let audioPlaying   = false;
let currentSource  = null;

// Recording
let mediaRecorder  = null;
let audioChunks    = [];
let micStream      = null;

// Face detection
let faceModel      = null;
let noFaceTimer    = 0;
let lastFaceCount  = 1;
let procInterval   = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Load Modes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadModes() {
  try {
    const res   = await fetch('/modes');
    const modes = await res.json();
    const grid  = document.getElementById('mode-grid');
    grid.innerHTML = '';

    const modeKeys = Object.keys(modes);
    Object.entries(modes).forEach(([key, val], i) => {
      const card = document.createElement('div');
      card.className = 'mode-card' + (i === 0 ? ' selected' : '');
      card.dataset.mode = key;
      card.innerHTML = `<div class="mode-emoji">${val.emoji}</div><div class="mode-title">${val.title}</div>`;
      card.addEventListener('click', () => {
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedMode = key;
      });
      grid.appendChild(card);
    });

    selectedMode = modeKeys[0]; // Select first mode by default
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = false;
    startBtn.textContent = 'Start Interview â†’';
  } catch (err) {
    console.error('Failed to load modes:', err);
    alert('Failed to load interview modes. Please refresh the page.');
  }
}

loadModes();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('start-btn').addEventListener('click', async () => {
  const nameVal = document.getElementById('candidate-name').value.trim();
  if (!nameVal) { alert('Please enter your name'); return; }

  const btn = document.getElementById('start-btn');
  btn.disabled = true;
  btn.textContent = 'Starting...';

  try {
    // Request mic + webcam
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });

    // Attach webcam
    const video = document.getElementById('webcam');
    video.srcObject = new MediaStream(micStream.getVideoTracks());

    // Start mic recorder
    const audioOnlyStream = new MediaStream(micStream.getAudioTracks());
    mediaRecorder = new MediaRecorder(audioOnlyStream);
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.start(1000);

    // Create session on backend
    await fetch('/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: SESSION_ID,
        mode: selectedMode,
        candidate_name: nameVal
      })
    });

    // Update UI
    document.getElementById('mode-pill').textContent = selectedMode.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    document.getElementById('cand-display').textContent = nameVal;

    // Hide modal, show app
    document.getElementById('startup-modal').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    // Resume audio context (requires user gesture)
    await audioCtx.resume();

    // Start face detection
    initFaceDetection();

    // Tab switch detection
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) logSuspicious('TAB_SWITCH', 'Candidate switched to another tab or minimized window', 'danger');
    });

    // Start timer
    timerInterval = setInterval(() => {
      timerSec++;
      const m = String(Math.floor(timerSec / 60)).padStart(2,'0');
      const s = String(timerSec % 60).padStart(2,'0');
      document.getElementById('timer').textContent = `${m}:${s}`;
    }, 1000);

    // Begin interview
    await beginInterview();

  } catch (err) {
    btn.disabled = false;
    btn.textContent = 'Start Interview â†’';
    alert('Could not access camera/microphone: ' + err.message);
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACE DETECTION (BlazeFace via TF.js)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initFaceDetection() {
  try {
    setFaceStatus('warn', 'Loading face detector...');
    faceModel = await blazeface.load();
    setFaceStatus('ok', 'Face detected');
    procInterval = setInterval(runFaceDetection, 2500);
  } catch(e) {
    setFaceStatus('warn', 'Face detection unavailable');
    console.warn('BlazeFace load failed:', e);
  }
}

async function runFaceDetection() {
  if (!faceModel) return;
  const video = document.getElementById('webcam');
  if (video.readyState < 2) return;

  try {
    const preds = await faceModel.estimateFaces(video, false);
    const count = preds.length;

    if (count === 0) {
      noFaceTimer++;
      setFaceStatus('danger', 'Face not visible');
      if (noFaceTimer >= 3) {
        logSuspicious('NO_FACE', 'Candidate not visible for extended period', 'danger');
        noFaceTimer = 0;
      }
    } else {
      noFaceTimer = 0;
      if (count > 1) {
        setFaceStatus('warn', `${count} faces detected`);
        if (lastFaceCount <= 1) {
          logSuspicious('MULTIPLE_FACES', `${count} faces detected in camera frame`, 'danger');
        }
      } else {
        setFaceStatus('ok', 'Face detected');
      }
    }
    lastFaceCount = count;
  } catch(e) {}
}

function setFaceStatus(type, text) {
  const pill = document.getElementById('face-pill');
  const span = document.getElementById('face-text');
  pill.className = `face-pill ${type}`;
  span.textContent = text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCTORING LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function logSuspicious(type, desc, severity = 'warn') {
  flagCount++;
  const fc = document.getElementById('flag-count');
  fc.textContent = flagCount;
  fc.style.display = 'inline';

  const log  = document.getElementById('proctor-log');
  const empty = log.querySelector('.proctor-empty');
  if (empty) empty.remove();

  const now  = new Date().toLocaleTimeString();
  const item = document.createElement('div');
  item.className = `proctor-item ${severity}`;
  item.innerHTML = `<div class="proctor-time">${now}</div><div class="proctor-desc">[${type}] ${desc}</div>`;
  log.appendChild(item);
  log.scrollTop = log.scrollHeight;

  // Notify backend
  fetch('/log-suspicious', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ session_id: SESSION_ID, event_type: type, description: desc })
  }).catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO QUEUE (Web Audio API, gapless)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enqueueAudio(b64wav, speaker, text, bubbleEl) {
  audioQueue.push({ b64wav, speaker, text, bubbleEl });
  if (!audioPlaying) drainQueue();
}

async function drainQueue() {
  if (audioQueue.length === 0) { audioPlaying = false; return; }
  audioPlaying = true;

  const { b64wav, speaker, text, bubbleEl } = audioQueue.shift();
  setSpeaking(speaker);

  if (bubbleEl) {
    bubbleEl.classList.remove('cursor');
    const body = bubbleEl.querySelector('.bbody');
    body.textContent = body.textContent ? body.textContent + ' ' + text : text;
    bubbleEl.classList.add('cursor');
    document.getElementById('chat-box').scrollTop = 99999;
  }

  if (!b64wav) { setTimeout(drainQueue, 30); return; }

  try {
    const raw   = atob(b64wav);
    const bytes = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) bytes[i] = raw.charCodeAt(i);
    const decoded = await audioCtx.decodeAudioData(bytes.buffer);
    const src     = audioCtx.createBufferSource();
    src.buffer    = decoded;
    src.connect(audioCtx.destination);
    currentSource = src;
    src.onended   = () => {
      if (bubbleEl) bubbleEl.classList.remove('cursor');
      currentSource = null;
      setSpeaking(null);
      drainQueue();
    };
    src.start();
  } catch(e) {
    if (bubbleEl) bubbleEl.classList.remove('cursor');
    currentSource = null;
    setSpeaking(null);
    drainQueue();
  }
}

// Interrupt â€” stop current audio and clear queue
function interruptAudio() {
  if (currentSource) { try { currentSource.stop(); } catch(e) {} currentSource = null; }
  audioQueue.length = 0;
  audioPlaying = false;
  setSpeaking(null);
  document.querySelectorAll('.bubble.alex .cursor, .bubble.sam .cursor')
    .forEach(b => b.classList.remove('cursor'));
}

function setSpeaking(s) {
  document.getElementById('card-alex').classList.toggle('speaking', s === 'alex');
  document.getElementById('card-sam').classList.toggle('speaking',  s === 'sam');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SSE STREAM CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentBubbles = {};

function getOrMakeBubble(speaker) {
  if (currentBubbles[speaker]) return currentBubbles[speaker];
  const labels = { alex:'ğŸ§‘â€ğŸ’» Alex', sam:'ğŸ§‘â€ğŸ’¼ Sam', user:'ğŸ§‘ You' };
  const div = document.createElement('div');
  div.className = `bubble ${speaker}`;
  div.innerHTML = `<div class="bname">${labels[speaker]||speaker}</div><div class="bbody"></div>`;
  document.getElementById('chat-box').appendChild(div);
  document.getElementById('chat-box').scrollTop = 99999;
  currentBubbles[speaker] = div;
  return div;
}

function addSysBubble(text) {
  const div = document.createElement('div');
  div.className = 'bubble sys';
  div.textContent = text;
  document.getElementById('chat-box').appendChild(div);
  document.getElementById('chat-box').scrollTop = 99999;
}

async function streamChat(message) {
  currentBubbles = {};
  const res = await fetch('/chat/stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message, session_id: SESSION_ID })
  });

  const reader = res.body.getReader();
  const dec    = new TextDecoder();
  let buf      = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buf += dec.decode(value, { stream: true });
    const lines = buf.split('\n');
    buf = lines.pop();

    for (const line of lines) {
      if (!line.startsWith('data: ')) continue;
      const data = JSON.parse(line.slice(6));

      if (data.type === 'speaker_start') {
        getOrMakeBubble(data.speaker);
        const speakerName = data.speaker === 'alex' ? 'Alex' : 'Sam';
        setStatus(`ğŸ¤ ${speakerName} is speaking...`);
      }
      if (data.type === 'sentence') {
        const bubble = getOrMakeBubble(data.speaker);
        enqueueAudio(data.audio, data.speaker, data.text, bubble);
      }
      if (data.type === 'done') {
        waitForAudioThenUnlock();
      }
    }
  }
}

function waitForAudioThenUnlock() {
  const check = setInterval(() => {
    if (!audioPlaying && audioQueue.length === 0) {
      clearInterval(check);
      setSpeaking(null);
      setBusy(false);
      setStatus('Click ğŸ™ï¸ to speak or type your answer');
      updateMicBtn();
    }
  }, 200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const msg = document.getElementById('input-box').textContent.trim();
  if (!msg) return;

  // If panel is talking, interrupt first
  if (audioPlaying || audioQueue.length > 0) interruptAudio();

  setBusy(true);
  document.getElementById('input-box').textContent = '';

  const userBubble = getOrMakeBubble('user');
  userBubble.querySelector('.bbody').textContent = msg;
  document.getElementById('chat-box').scrollTop = 99999;

  setStatus('ğŸ’­ Panel is thinking...');

  try {
    await streamChat(msg);
  } catch(err) {
    setStatus('âŒ Server error. Is FastAPI running?');
    setBusy(false);
  }
}

document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('input-box').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MICROPHONE + INTERRUPTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateMicBtn() {
  const btn  = document.getElementById('mic-btn');
  const busy = audioPlaying || audioQueue.length > 0;
  if (isListening) {
    btn.textContent = 'â¹ï¸';
    btn.classList.add('listening');
    btn.classList.remove('interrupt');
  } else if (busy) {
    btn.textContent = 'âœ‹ Interrupt';
    btn.classList.add('interrupt');
    btn.classList.remove('listening');
  } else {
    btn.textContent = 'ğŸ™ï¸';
    btn.classList.remove('listening','interrupt');
  }
}

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => { isListening = true; updateMicBtn(); setStatus('ğŸ”´ Listening...'); };

  recognition.onresult = e => {
    let final = '', interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      e.results[i].isFinal
        ? final   += e.results[i][0].transcript
        : interim += e.results[i][0].transcript;
    }
    document.getElementById('input-box').textContent = final || interim;
  };

  recognition.onend = () => {
    isListening = false;
    updateMicBtn();
    if (document.getElementById('input-box').textContent.trim()) sendMessage();
    else setStatus('Click ğŸ™ï¸ to speak or type your answer');
  };

  recognition.onerror = e => {
    isListening = false;
    updateMicBtn();
    setStatus(`Mic error: ${e.error}`);
  };

} else {
  document.getElementById('mic-btn').disabled = true;
}

document.getElementById('mic-btn').addEventListener('click', async () => {
  if (audioCtx.state === 'suspended') await audioCtx.resume();

  // If panel is talking â€” interrupt
  if ((audioPlaying || audioQueue.length > 0) && !isListening) {
    interruptAudio();
    addSysBubble('âš¡ Candidate interrupted the panel');
    logSuspicious('INTERRUPT', 'Candidate interrupted panelists mid-response', 'warn');
    setTimeout(() => {
      if (!isBusy) {
        document.getElementById('input-box').textContent = '';
        recognition?.start();
      }
    }, 300);
    return;
  }

  if (!recognition) return;
  isListening ? recognition.stop() : (document.getElementById('input-box').textContent = '', recognition.start());
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END INTERVIEW + FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('end-btn').addEventListener('click', async () => {
  if (!confirm('End the interview and generate your feedback report?')) return;

  clearInterval(timerInterval);
  if (procInterval) clearInterval(procInterval);
  interruptAudio();
  recognition?.stop();
  if (mediaRecorder?.state !== 'inactive') mediaRecorder?.stop();

  setBusy(true);
  setStatus('â³ Generating your feedback report...');

  try {
    const res  = await fetch('/feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ session_id: SESSION_ID })
    });
    const data = await res.json();

    if (data.error) { alert('Feedback error: ' + data.error); setBusy(false); return; }
    renderFeedback(data);
    document.getElementById('feedback-modal').classList.remove('hidden');
  } catch(e) {
    alert('Could not generate feedback: ' + e.message);
  }
  setBusy(false);
});

function renderFeedback(d) {
  // Verdict badge
  const vb = document.getElementById('verdict-badge');
  const vclass = d.verdict?.toLowerCase().replace(' ', '_') || 'hold';
  vb.className = `verdict-badge ${vclass}`;
  vb.textContent = d.verdict || '--';

  // Score
  const score = parseFloat(d.overall_score) || 0;
  document.getElementById('score-num').textContent = score.toFixed(1);
  const circle = document.getElementById('score-circle');
  const hue = Math.round((score / 10) * 120); // redâ†’green
  circle.style.borderColor = `hsl(${hue},70%,50%)`;

  document.getElementById('fb-summary').textContent = d.summary || '';

  // Categories
  const grid = document.getElementById('categories-grid');
  grid.innerHTML = '';
  const cats = d.categories || {};
  Object.entries(cats).forEach(([key, val]) => {
    const card = document.createElement('div');
    card.className = 'cat-card';
    const pct = Math.round(((val.score || 0) / 10) * 100);
    card.innerHTML = `
      <div class="cat-name">${key.replace('_',' ')}</div>
      <div class="cat-bar-wrap"><div class="cat-bar" style="width:0%" data-w="${pct}%"></div></div>
      <div style="font-size:.7rem;color:var(--muted);margin-bottom:4px">${val.score || 0}/10</div>
      <div class="cat-feedback">${val.feedback || ''}</div>
    `;
    grid.appendChild(card);
  });
  // Animate bars
  setTimeout(() => {
    document.querySelectorAll('.cat-bar').forEach(b => b.style.width = b.dataset.w);
  }, 100);

  // Strengths
  const sl = document.getElementById('strengths-list');
  sl.innerHTML = (d.strengths || []).map(s => `<li>âœ… ${s}</li>`).join('');

  // Improvements
  const il = document.getElementById('improvements-list');
  il.innerHTML = (d.improvements || []).map(i => `<li>ğŸ“ˆ ${i}</li>`).join('');

  // Integrity
  const ib = document.getElementById('integrity-box');
  const isClean = (d.integrity_note || '').toLowerCase().includes('no issue');
  ib.className = `integrity-box ${isClean ? 'ok' : ''}`;
  ib.textContent = `ğŸ” Integrity: ${d.integrity_note || 'No issues detected'}`;

  // Recommendation
  document.getElementById('recommendation-box').textContent = d.recommendation || '';
}

document.getElementById('close-feedback-btn').addEventListener('click', () => {
  document.getElementById('feedback-modal').classList.add('hidden');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOWNLOAD TRANSCRIPT + AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('dl-transcript-btn').addEventListener('click', async () => {
  const res  = await fetch(`/transcript/${SESSION_ID}`);
  const data = await res.json();

  // Build readable text
  let text = `AI Interview Panel â€” ${data.mode} Interview\n`;
  text += `Candidate: ${data.candidate}\nDate: ${data.start_time}\n`;
  text += '='.repeat(50) + '\n\n';
  text += data.transcript.map(e =>
    `[${new Date(e.time).toLocaleTimeString()}] ${e.speaker.toUpperCase()}: ${e.text}`
  ).join('\n\n');

  if (data.suspicious_events?.length) {
    text += '\n\n' + '='.repeat(50) + '\nPROCTORING FLAGS:\n';
    text += data.suspicious_events.map(e =>
      `[${new Date(e.time).toLocaleTimeString()}] ${e.type}: ${e.description}`
    ).join('\n');
  }

  const blob = new Blob([text], { type: 'text/plain' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `interview_transcript_${SESSION_ID}.txt`;
  a.click();
  URL.revokeObjectURL(url);
});

document.getElementById('dl-audio-btn').addEventListener('click', () => {
  if (!audioChunks.length) { alert('No audio recorded yet.'); return; }
  const blob = new Blob(audioChunks, { type: 'audio/webm' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `interview_audio_${SESSION_ID}.webm`;
  a.click();
  URL.revokeObjectURL(url);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(msg) { document.getElementById('status').textContent = msg; }

function setBusy(val) {
  isBusy = val;
  document.getElementById('send-btn').disabled = val;
  document.getElementById('end-btn').disabled  = val;
  updateMicBtn();
  if (val) document.getElementById('mic-btn').disabled = false; // mic always available for interrupt
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEGIN INTERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function beginInterview() {
  addSysBubble('Interview starting â€” panel is joining...');
  setBusy(true);
  setStatus('â³ Panel is joining...');
  try {
    await streamChat("Hello, I am ready to begin. Please introduce yourselves and start the interview.");
  } catch(e) {
    setStatus('âŒ Cannot connect. Run: uvicorn main:app --reload');
    setBusy(false);
  }
}
</script>
</body>
</html>